services:
  nginx:
    image: nginx:alpine
    container_name: ntd-nginx
    entrypoint: ["/docker-entrypoint.sh"]
    ports:
      - "80:80"
    environment:
      - DASHBOARD_USER=${DASHBOARD_USER:-admin}
      - DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD}
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/docker-entrypoint.sh:/docker-entrypoint.sh:ro
    depends_on:
      - frontend
      - backend
      - victorialogs
    networks:
      - ntd-network

  backend:
    build: ./backend
    container_name: ntd-backend
    expose:
      - "8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - IB_GATEWAY_HOST=ib-gateway
      - IB_GATEWAY_PORT=4004
      - TWS_ACCOUNT=${TWS_ACCOUNT}
      - TWS_USERID=${TWS_USERID}
      - TWS_PASSWORD=${TWS_PASSWORD}
      - TRADING_MODE=${TRADING_MODE:-paper}
    depends_on:
      - redis
      - ib-gateway
      - victorialogs
    networks:
      - ntd-network
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs

  frontend:
    build: ./frontend
    container_name: ntd-frontend
    expose:
      - "5173"
    environment:
      - VITE_API_URL=/
    depends_on:
      - backend
    networks:
      - ntd-network
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public

  redis:
    image: redis:alpine
    container_name: ntd-redis
    command: redis-server --appendonly yes
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - ntd-network

  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: ntd-ib-gateway
    restart: unless-stopped
    environment:
      # Login credentials (from .env file)
      TWS_USERID: ${TWS_USERID}
      TWS_PASSWORD: ${TWS_PASSWORD}
      TRADING_MODE: ${TRADING_MODE:-paper}
      # VNC for 2FA - connect with VNC client to port 5900
      VNC_SERVER_PASSWORD: ${VNC_SERVER_PASSWORD:-}
      # 2FA settings
      TWOFA_TIMEOUT_ACTION: ${TWOFA_TIMEOUT_ACTION:-exit}
      RELOGIN_AFTER_TWOFA_TIMEOUT: ${RELOGIN_AFTER_TWOFA_TIMEOUT:-no}
      TWOFA_EXIT_INTERVAL: ${TWOFA_EXIT_INTERVAL:-60}
      # API settings
      READ_ONLY_API: ${READ_ONLY_API:-no}
      TWS_ACCEPT_INCOMING: ${TWS_ACCEPT_INCOMING:-accept}
      EXISTING_SESSION_DETECTED_ACTION: ${EXISTING_SESSION_DETECTED_ACTION:-primary}
      # Timezone
      TIME_ZONE: ${TIME_ZONE:-Etc/UTC}
      TZ: ${TIME_ZONE:-Etc/UTC}
    ports:
      # VNC port for 2FA access (use VNC client)
      - "5900:5900"
      # IB API ports removed - backend uses internal Docker network
    networks:
      - ntd-network

  # VictoriaLogs - Log storage with 14-day retention
  victorialogs:
    image: victoriametrics/victoria-logs:v1.43.1
    container_name: ntd-victorialogs
    command:
      - -storageDataPath=/data
      - -retentionPeriod=14d
      - -httpListenAddr=:9428
    volumes:
      - victorialogs-data:/data
    expose:
      - "9428"
    networks:
      - ntd-network
    restart: unless-stopped

  # Vector - Container log collector (lightweight, Rust-based)
  vector:
    image: timberio/vector:0.52.0-alpine
    container_name: ntd-vector
    command: ["--config", "/etc/vector/vector.toml"]
    volumes:
      - ./vector/vector.toml:/etc/vector/vector.toml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - ntd-network
    depends_on:
      - victorialogs
    restart: unless-stopped

networks:
  ntd-network:
    driver: bridge

volumes:
  victorialogs-data:
  redis-data:
