events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    upstream frontend {
        server frontend:5173;
    }

    upstream backend {
        server backend:8000;
    }

    upstream victorialogs {
        server victorialogs:9428;
    }

    server {
        listen 80;

        # Cookie-based session authentication
        error_page 401 = @login_redirect;

        location @login_redirect {
            return 302 /login;
        }

        # Validate session with backend
        location = /auth/validate {
            internal;
            proxy_pass http://backend/auth/validate;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Cookie $http_cookie;
        }

        # Login page (no auth)
        location /login {
            auth_request off;
            proxy_pass http://backend/login;
            proxy_set_header Host $host;
        }

        # Logout (no auth required to ensure we can always clear cookies)
        location /logout {
            auth_request off;
            proxy_pass http://backend/logout;
            proxy_set_header Host $host;
        }

        # Frontend (Protection enabled)
        location / {
            auth_request /auth/validate;
            
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Backend Health (no auth for health checks)
        location /health {
            auth_request off;
            proxy_pass http://backend/health;
        }

        # Strategy Management
        location /strategies {
            auth_request /auth/validate;
            access_log off;
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }

        # Analytics
        location /analytics {
            auth_request /auth/validate;
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }

        # Trades API (for all strategies aggregate)
        location /trades {
            auth_request /auth/validate;
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }

        # Stats API (for all strategies aggregate)
        location /stats {
            auth_request /auth/validate;
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }

        # Logs API
        location /api/logs {
            auth_request /auth/validate;
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }

        # WebSocket
        location /ws {
            # Note: WebSockets credentials via cookie should work if auth_request is called on upgrade
            # Some clients might need special handling, but browsers send cookies on WS upgrade.
            auth_request /auth/validate;
            
            access_log off;
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
        }

        # VictoriaLogs UI
        location /vmui {
            auth_request /auth/validate;
            proxy_pass http://victorialogs/select/vmui;
            proxy_set_header Host $host;
        }

        # VictoriaLogs API (for vmui queries)
        location /select/ {
            auth_request /auth/validate;
            proxy_pass http://victorialogs/select/;
            proxy_set_header Host $host;
        }
    }
}
